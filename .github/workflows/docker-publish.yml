name: Build & deploy application

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  push:
    branches: [ "master" ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]
    paths-ignore:
      - '**.md'
      - 'Documentation/**'
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - '**.md'
      - 'Documentation/**'
  workflow_dispatch:
    
env:
  # Use docker.io for Docker Hub if empty
  #REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}
  
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
jobs:
  build-test-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Setup .NET Environment
        uses: ./.github/actions/setup-dotnet

      - name: Install Mono
        run: |
          sudo apt update
          sudo apt install -y mono-complete
      - name: Install SonarCloud scanners
        run: |
          dotnet tool install --global dotnet-sonarscanner
          dotnet tool install --global dotnet-coverage
      - name: Add .NET global tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Begin SonarCloud analysis
        if: env.SONAR_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet-sonarscanner begin /k:"VibeNL_GhostfolioSidekick" /o:"vibenl" /d:sonar.login="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.vscoveragexml.reportsPaths=coverage.xml

      - name: Build
        run: dotnet build

      - name: Install Playwright Browsers for all test targets
        run: |
          find . -type f -name 'playwright.ps1' | while read script; do
            pwsh "$script" install
          done

      - name: Run tests and collect coverage
        run: dotnet-coverage collect "dotnet test" -f xml -o "coverage.xml"

      - name: End SonarCloud analysis
        if: env.SONAR_TOKEN != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
      - name: Upload Playwright screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: PortfolioViewer/PortfolioViewer.WASM.UITests/**/playwright-screenshots
      - name: Upload Playwright videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: PortfolioViewer/PortfolioViewer.WASM.UITests/**/playwright-videos
      - name: Upload Playwright error HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-error-html
          path: PortfolioViewer/PortfolioViewer.WASM.UITests/**/*.html

      - name: Check for Playwright failures
        if: failure()
        run: |
          echo "Playwright tests failed. Checking for error artifacts..."
          find PortfolioViewer/PortfolioViewer.WASM.UITests -name '*.html' -o -name '*.png' | head -20

      - name: List Playwright error HTML files
        if: always()
        run: find PortfolioViewer/PortfolioViewer.WASM.UITests -name 'mainpage-error-*.html' -print

  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Setup .NET Environment
        uses: ./.github/actions/setup-dotnet
      - name: Install cosign
        if: github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@v3.3.0
        with:
          cosign-release: 'v2.1.1'
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v3
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: vibenl/ghostfoliosidekick
          tags: |
            # set v2 tag for default branch
            type=raw,value=v2,enable={{is_default_branch}}
            type=ref,event=pr
            # set latest tag for default branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short
      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64

  dotnet-vulnerability-scan:
    runs-on: ubuntu-latest
    needs: build-test-analyze
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Setup .NET Environment
        uses: ./.github/actions/setup-dotnet
      - name: Restore packages
        run: dotnet restore
      - name: Scan for deprecated packages
        run: |
          echo "Scanning for deprecated NuGet packages..."
          deprecated_output=$(dotnet list package --deprecated)
          echo "$deprecated_output"
          if echo "$deprecated_output" | grep -q "has the following deprecated packages"; then
            echo "⚠️  Deprecated packages found!"
            exit 1  # Fail the build for deprecated packages
          else
            echo "✅ No deprecated packages found."
          fi
      - name: Scan for vulnerable packages
        run: |
          echo "Scanning for vulnerable NuGet packages..."
          vulnerable_output=$(dotnet list package --vulnerable)
          echo "$vulnerable_output"
          if echo "$vulnerable_output" | grep -q "has the following vulnerable packages"; then
            echo "❌ Vulnerable packages found!"
            exit 1  # Fail the build for vulnerable packages
          else
            echo "✅ No vulnerable packages found."
          fi
      - name: Install OSV Scanner
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
      - name: Run OSV Scanner for additional deprecation and vulnerability checks
        run: |
          echo "Running OSV Scanner for comprehensive security analysis..."
          ./osv-scanner --format table --recursive .
        continue-on-error: true  # Don't fail the build if OSV scanner finds issues, just report them
      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

  docker-vulnerability-scan:
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Set image tag for scanning
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "tag=vibenl/ghostfoliosidekick:pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          else
            echo "tag=vibenl/ghostfoliosidekick:latest" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Docker image to be available
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master'
        run: |
          echo "Waiting for Docker image to be published..."
          sleep 60

      - name: Run Trivy vulnerability scanner
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.set-tag.outputs.tag }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'library'
          severity: 'CRITICAL,HIGH'

  notify:
    runs-on: ubuntu-latest
    needs: [build-test-analyze, publish, dotnet-vulnerability-scan, docker-vulnerability-scan]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Create a PR comment with the published version
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ### Development container published

            Install with:

            ```
            docker pull vibenl/ghostfoliosidekick:pr-${{ github.event.number }}
            ```
          comment_tag: "development-ghostfoliosidekick-published"
          mode: "recreate"
          pr_number: ${{ github.event.number }}