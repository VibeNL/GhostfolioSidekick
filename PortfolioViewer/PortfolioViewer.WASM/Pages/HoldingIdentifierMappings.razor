@page "/holding-identifier-mappings"
@page "/holding-identifier-mappings/{symbol?}"
@using Microsoft.AspNetCore.Authorization
@using GhostfolioSidekick.PortfolioViewer.WASM.Models
@using GhostfolioSidekick.PortfolioViewer.WASM.Components
@using GhostfolioSidekick.Model
@using GhostfolioSidekick.PortfolioViewer.WASM.Data.Models
@inject GhostfolioSidekick.PortfolioViewer.WASM.Services.IHoldingIdentifierMappingService HoldingIdentifierMappingService
@inject GhostfolioSidekick.PortfolioViewer.WASM.Services.ITestContextService TestContextService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>@(string.IsNullOrEmpty(Symbol) ? "Identifier Mappings" : $"{Symbol} - Identifier Mapping")</PageTitle>

<div class="container-fluid">
    @if (!string.IsNullOrEmpty(Symbol))
    {
        <!-- Breadcrumb for single holding view -->
        <div class="row mb-3">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/holdings" class="text-decoration-none">
                                <i class="bi bi-pie-chart"></i> Holdings
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/holding-identifier-mappings" class="text-decoration-none">
                                <i class="bi bi-diagram-3"></i> Identifier Mappings
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">@Symbol</li>
                    </ol>
                </nav>
            </div>
        </div>
    }

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">
                        <i class="bi bi-diagram-3 me-2"></i>
                        @if (string.IsNullOrEmpty(Symbol))
                        {
                            <span>Identifier Mappings</span>
                        }
                        else
                        {
                            <span>@Symbol - Identifier Mapping</span>
                        }
                    </h1>
                    <p class="text-muted">
                        @if (string.IsNullOrEmpty(Symbol))
                        {
                            <span>View how partial identifiers from activities are matched to external data providers for all holdings</span>
                        }
                        else
                        {
                            <span>Detailed view of how partial identifiers are matched to external data providers for @Symbol</span>
                        }
                    </p>
                </div>
                <div>
                    @if (!string.IsNullOrEmpty(Symbol))
                    {
                        <a href="/holding-identifier-mappings" class="btn btn-outline-primary ms-2">
                            <i class="bi bi-list"></i> View All
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (IsLoading)
    {
        <!-- Loading State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="text-muted">Loading Identifier Mappings...</h5>
                        <p class="text-muted mb-0">Please wait while we fetch the mapping information.</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (HasError)
    {
        <!-- Error State -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Error Loading Data</h4>
                    <p>@ErrorMessage</p>
                    <hr>
                </div>
            </div>
        </div>
    }
    else if (HoldingMappings.Count == 0)
    {
        <!-- Empty State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-diagram-3 text-muted" style="font-size: 4rem;"></i>
                        <h5 class="text-muted mt-3">No Identifier Mappings Found</h5>
                        <p class="text-muted mb-3">
                            @if (string.IsNullOrEmpty(Symbol))
                            {
                                <span>No holdings with identifier mappings were found.</span>
                            }
                            else
                            {
                                <span>No identifier mapping found for @Symbol.</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Main Content -->
        @if (string.IsNullOrEmpty(Symbol))
        {
            <!-- Overview mode - show all holdings -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Holdings Identifier Mappings Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">
                                                <SortableTableHeader Column="Symbol"
                                                                     DisplayName="Symbol"
                                                                     CurrentSortColumn="@sortColumn"
                                                                     IsAscending="@sortAscending"
                                                                     OnSort="SortBy" />
                                            </th>
                                            <th scope="col">
                                                <SortableTableHeader Column="Name"
                                                                     DisplayName="Name"
                                                                     CurrentSortColumn="@sortColumn"
                                                                     IsAscending="@sortAscending"
                                                                     OnSort="SortBy" />
                                            </th>
                                            <th scope="col" class="text-center">Partial Identifiers</th>
                                            <th scope="col" class="text-center">Data Providers</th>
                                            <th scope="col" class="text-center">Status</th>
                                            <th scope="col" class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var mapping in HoldingMappings)
                                        {
                                            var hasUnresolvedIdentifiers = mapping.PartialIdentifiers.Any(pi => pi.HasUnresolvedMapping);
                                            <tr class="@(hasUnresolvedIdentifiers ? "table-warning" : "")">
                                                <td>
                                                    <strong>@mapping.Symbol</strong>
                                                </td>
                                                <td>@mapping.Name</td>
                                                <td class="text-center">
                                                    <span class="badge bg-info">@mapping.PartialIdentifiers.Count</span>
                                                    @if (hasUnresolvedIdentifiers)
                                                    {
                                                        <span class="badge bg-warning ms-1" title="Has unresolved identifiers">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">@mapping.DataProviderMappings.Count</span>
                                                </td>
                                                <td class="text-center">
                                                    @if (hasUnresolvedIdentifiers)
                                                    {
                                                        <span class="badge bg-warning">
                                                            <i class="bi bi-exclamation-triangle me-1"></i>Issues
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle me-1"></i>OK
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <a href="/holding-identifier-mappings/@mapping.Symbol" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i> View Details
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Detail mode - show single holding -->
            @if (CurrentHoldingMapping != null)
            {
                <!-- Merged Partial Identifiers & Data Provider Mappings Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-diagram-3 me-2"></i>Partial Identifiers & Data Provider Mappings
                                </h5>
                                <small class="text-muted">All partial identifiers and their data provider mappings</small>
                            </div>
                            <div class="card-body">
                                @if (CurrentHoldingMapping.PartialIdentifiers.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Identifier</th>
                                                    <th>Asset Classes</th>
                                                    <th>Asset Sub-Classes</th>
                                                    <th>Matched Provider</th>
                                                    <th>Provider Symbol</th>
                                                    <th>Provider Name</th>
                                                    <th>ISIN</th>
                                                    <th>Asset Class</th>
                                                    <th>Currency</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var partialId in CurrentHoldingMapping.PartialIdentifiers)
                                                {
                                                    var relatedProviders = CurrentHoldingMapping.DataProviderMappings
                                                    .Where(m => m.MatchedPartialIdentifiers.Contains(partialId.Identifier) || m.MatchedPartialIdentifiers.Count == 0)
                                                    .ToList();
                                                    if (relatedProviders.Any())
                                                    {
                                                        foreach (var provider in relatedProviders)
                                                        {
                                                            <tr class="@(partialId.HasUnresolvedMapping ? "table-warning" : "")">
                                                                <td><strong>@partialId.Identifier</strong></td>
                                                                <td>
                                                                    @if (partialId.AllowedAssetClasses?.Any() == true)
                                                                    {
                                                                        @foreach (var assetClass in partialId.AllowedAssetClasses)
                                                                        {
                                                                            <span class="badge bg-secondary me-1">@assetClass</span>
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    @if (partialId.AllowedAssetSubClasses?.Any() == true)
                                                                    {
                                                                        @foreach (var assetSubClass in partialId.AllowedAssetSubClasses)
                                                                        {
                                                                            <span class="badge bg-info me-1">@assetSubClass</span>
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                                <td><span class="badge bg-primary">@provider.DataSource</span></td>
                                                                <td><strong>@provider.Symbol</strong></td>
                                                                <td>@provider.Name</td>
                                                                <td>
                                                                    @if (!string.IsNullOrEmpty(provider.ISIN))
                                                                    {
                                                                        <code>@provider.ISIN</code>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-secondary">@provider.AssetClass</span>
                                                                    @if (provider.AssetSubClass.HasValue)
                                                                    {
                                                                        <br />
                                                                        <span class="badge bg-info mt-1">@provider.AssetSubClass</span>
                                                                    }
                                                                </td>
                                                                <td><span class="badge bg-success">@provider.Currency</span></td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr class="@(partialId.HasUnresolvedMapping ? "table-warning" : "")">
                                                            <td><strong>@partialId.Identifier</strong></td>
                                                            <td>
                                                                @if (partialId.AllowedAssetClasses?.Any() == true)
                                                                {
                                                                    @foreach (var assetClass in partialId.AllowedAssetClasses)
                                                                    {
                                                                        <span class="badge bg-secondary me-1">@assetClass</span>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                @if (partialId.AllowedAssetSubClasses?.Any() == true)
                                                                {
                                                                    @foreach (var assetSubClass in partialId.AllowedAssetSubClasses)
                                                                    {
                                                                        <span class="badge bg-info me-1">@assetSubClass</span>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            </td>
                                                            <td colspan="7" class="text-muted"><i class="bi bi-dash-circle me-1"></i>No matches found</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center py-3">
                                        <i class="bi bi-tags text-muted" style="font-size:2rem;"></i>
                                        <p class="text-muted mt-2">No partial identifiers found for this holding.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Transactions Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-receipt me-2"></i>Related Transactions
                                </h5>
                                <small class="text-muted">All transactions for this holding</small>
                            </div>
                            <div class="card-body">
                                @if (IsTransactionsLoading)
                                {
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary mb-2" role="status">
                                            <span class="visually-hidden">Loading transactions...</span>
                                        </div>
                                        <div class="text-muted">Loading transactions...</div>
                                    </div>
                                }
                                else if (TransactionsError)
                                {
                                    <div class="alert alert-danger" role="alert">
                                        <strong>Error loading transactions:</strong> @TransactionsErrorMessage
                                    </div>
                                }
                                else if (RelatedTransactions.Count == 0)
                                {
                                    <div class="text-center py-3">
                                        <i class="bi bi-receipt text-muted" style="font-size: 2rem;"></i>
                                        <p class="text-muted mt-2">No transactions found for this holding.</p>
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Account</th>
                                                    <th class="text-end">Total Value</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var txn in RelatedTransactions)
                                                {
                                                    <tr @onclick="() => ShowTransactionDetails(txn)" style="cursor:pointer;">
                                                        <td>@txn.Date.ToString("yyyy-MM-dd")</td>
                                                        <td><span class="badge bg-secondary">@txn.Type</span></td>
                                                        <td>@txn.AccountName</td>
                                                        <td class="text-end">
                                                            @if (txn.TotalValue != null)
                                                            {
                                                                <strong>@CurrencyDisplay.DisplaySignAndAmount(txn.TotalValue)</strong>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td>@txn.Description</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    }
</div>

@* Transaction Details Modal *@
@if (ShowTransactionModal && SelectedTransaction != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseTransactionModal"></button>
                </div>
                <div class="modal-body">
                    <dl class="row">
                        <dt class="col-sm-3">Date</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Date.ToString("yyyy-MM-dd")</dd>
                        <dt class="col-sm-3">Type</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Type</dd>
                        <dt class="col-sm-3">Account</dt>
                        <dd class="col-sm-9">@SelectedTransaction.AccountName</dd>
                        <dt class="col-sm-3">Symbol</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Symbol</dd>
                        <dt class="col-sm-3">Name</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Name</dd>
                        <dt class="col-sm-3">Description</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Description</dd>
                        <dt class="col-sm-3">Total Value</dt>
                        <dd class="col-sm-9">
                            @if (SelectedTransaction.TotalValue != null)
                            {
                                @CurrencyDisplay.DisplaySignAndAmount(SelectedTransaction.TotalValue)
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </dd>
                        <dt class="col-sm-3">Fee</dt>
                        <dd class="col-sm-9">
                            @if (SelectedTransaction.Fee != null)
                            {
                                @CurrencyDisplay.DisplaySignAndAmount(SelectedTransaction.Fee)
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </dd>
                        <dt class="col-sm-3">Tax</dt>
                        <dd class="col-sm-9">
                            @if (SelectedTransaction.Tax != null)
                            {
                                @CurrencyDisplay.DisplaySignAndAmount(SelectedTransaction.Tax)
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </dd>
                        <dt class="col-sm-3">Transaction Id</dt>
                        <dd class="col-sm-9">@SelectedTransaction.TransactionId</dd>
                        <dt class="col-sm-3">Quantity</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Quantity</dd>
                        <dt class="col-sm-3">Unit Price</dt>
                        <dd class="col-sm-9">
                            @if (SelectedTransaction.UnitPrice != null)
                            {
                                @CurrencyDisplay.DisplaySignAndAmount(SelectedTransaction.UnitPrice)
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </dd>
                        <dt class="col-sm-3">Currency</dt>
                        <dd class="col-sm-9">@SelectedTransaction.Currency</dd>
                    </dl>
                    @* Issue detection example *@
                    @if (string.IsNullOrWhiteSpace(SelectedTransaction.Symbol))
                    {
                        <div class="alert alert-warning mt-3">
                            <strong>Potential Issues Detected:</strong>
                            <ul>
                                <li>Symbol is missing.</li>
                            </ul>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseTransactionModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .table th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .card .card-body {
        padding: 1rem;
    }

    .badge {
        font-size: 0.75em;
    }

    .table-responsive {
        border-radius: 0.375rem;
    }

    .card-header small {
        display: block;
        margin-top: 0.25rem;
    }

    .modal {
        display: block;
    }
</style>

@code {
    private GhostfolioSidekick.PortfolioViewer.WASM.Data.Models.TransactionDisplayModel? SelectedTransaction { get; set; }
    private bool ShowTransactionModal { get; set; }

    private void ShowTransactionDetails(GhostfolioSidekick.PortfolioViewer.WASM.Data.Models.TransactionDisplayModel txn)
    {
        SelectedTransaction = txn;
        ShowTransactionModal = true;
    }

    private void CloseTransactionModal()
    {
        ShowTransactionModal = false;
        SelectedTransaction = null;
    }
}